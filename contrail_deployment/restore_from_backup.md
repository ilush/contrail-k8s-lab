# Restore Contrail Config DB (Cassandra and Zookeeper) from backup generated by db_json_exim.py

1. Copy current Config-API config file to host

```bash
kubectl -n kube-system cp contrail-controller-config-k86p2:/etc/contrail/ ./api-conf/
```

1. Stop Config services, ZK and Config Cassandra

```bash
kubectl -n kube-system delete ds contrail-controller-config config-zookeeper contrail-configdb
```

1. Purge ZK and Config Cassandra data from host

```bash
rm -rf /var/lib/contrail/configdb/*
rm -rf /var/lib/contrail/config-zookeeper/*
```

1. Start ZK and Config Cassandra DeamonSets

```bash
kubectl apply -f contrail-k8s-lab/contrail_deployment/ds-config-zookeeper.yaml
kubectl apply -f contrail-k8s-lab/contrail_deployment/ds-contrail-configdb.yaml
```

1. Run shell from config-api image, which contains db-dump.py script. Import data from backup.

```bash
docker run --rm -it -v /root/tmp:/tmp/ -v /etc/contrail/ssl:/etc/contrail/ssl:ro --network host --entrypoint=/bin/bash hub.juniper.net/contrail/contrail-controller-config-api:2011.138


$ cd /usr/lib/python2.7/site-packages/cfgm_common
$ python db_json_exim.py --import-from /tmp/db-dump/db-dump.json --api-conf /tmp/contrail-api-0.conf
```

1. Start Config services

```bash
kubectl apply -f contrail-k8s-lab/contrail_deployment/ds-contrail-controller-config.yaml
```
